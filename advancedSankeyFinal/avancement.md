# üìã Avancement du Projet AdvancedSankey

## 30 juin 2025 - Nettoyage des propri√©t√©s obsol√®tes

### ‚åõ Changement :
**Suppression des propri√©t√©s non utilis√©es** dans le fichier XML du widget pour simplifier l'interface et √©viter la confusion.

**Propri√©t√©s retir√©es** :
- `showPercentages` : Propri√©t√© non utilis√©e dans le code (les pourcentages sont affich√©s automatiquement sur les liens)
- `clickedNodeAttribute` : Propri√©t√© obsol√®te remplac√©e par `clickedAssetAttribute` pour la vue d√©taill√©e

**Propri√©t√©s conserv√©es** (toutes utilis√©es) :
- Configuration des flux : `energyFlowDataSource`, `sourceAssetAttribute`, `targetAssetAttribute`, `flowValueAttribute`, `percentageAttribute`
- Configuration √©nerg√©tique : `energyType`, `metricType`
- Affichage : `title`, `width`, `height`, `showValues`
- Interactions : `onNodeClick`, `onNodeDetails`, `clickedAssetAttribute`
- D√©veloppement : `showDebugTools`

### ü§î Analyse :
**Impact Maintenabilit√©** : Simplification de l'interface de configuration du widget, suppression de la confusion potentielle avec des propri√©t√©s non fonctionnelles. Les types TypeScript sont automatiquement mis √† jour.

**Impact UX** : Interface plus claire pour les d√©veloppeurs Mendix, moins de propri√©t√©s √† configurer inutilement.

### üíú Prochaines √©tapes :
- V√©rifier que le build fonctionne correctement apr√®s le nettoyage
- Optionnel : ajouter des validations pour s'assurer que toutes les propri√©t√©s requises sont configur√©es

## 30 juin 2025 - Impl√©mentation Vue D√©taill√©e (Ctrl+clic)

### ‚åõ Changement additionnel (interaction unifi√©e + fiabilit√© MF) :
- Uniformisation: **Ctrl+clic partout** pour ouvrir la vue d√©taill√©e. Le clic simple conserve uniquement la navigation (si enfants), sinon aucune action.
- Fiabilit√©: ex√©cution du microflow `onNodeDetails` au tick suivant apr√®s mise √† jour de `selectedAssetNameAttribute` (via `requestAnimationFrame`) afin d'√©viter une course o√π la valeur n'est pas encore visible c√¥t√© microflow.

### ü§î Analyse :
√âvite toute ambigu√Øt√© d‚ÄôUX; supprime les effets de bord o√π les datasources de page s‚Äôex√©cutaient avant que le nom s√©lectionn√© ne soit propag√©. En cas de besoin, on pourra augmenter le d√©lai (setTimeout 0‚Äì10ms) ou forcer un commit c√¥t√© microflow avant l‚Äôouverture de page.

### ‚åõ Changement :
**Nouvelle fonctionnalit√© d'interaction** : Ajout d'un syst√®me de vue d√©taill√©e accessible via Ctrl+clic sur les n≈ìuds du Sankey.

**Modifications apport√©es** :
- **XML Widget** : Ajout de 2 nouvelles propri√©t√©s :
  - `onNodeDetails` : Action Mendix pour ouvrir la vue d√©taill√©e
  - `clickedAssetAttribute` : Attribut pour stocker l'asset correspondant au n≈ìud cliqu√©
- **SankeyChart** : Gestion du Ctrl+clic avec logique intelligente :
  - Clic normal : drill-down si enfants, sinon vue d√©taill√©e
  - Ctrl+clic : vue d√©taill√©e quel que soit le n≈ìud
  - Tous les n≈ìuds sont maintenant cliquables (curseur pointer)
- **Tooltips** : Ajout de hints contextuels "Clic: navigation ‚Ä¢ Ctrl+clic: vue d√©taill√©e"
- **Mapping Asset** : Fonction `findAssetForNode()` pour r√©cup√©rer l'asset correspondant depuis les EnergyFlowNode

### ü§î Analyse :
**Impact UX** : L'utilisateur peut maintenant naviguer dans le Sankey ET acc√©der aux vues d√©taill√©es depuis le m√™me widget, avec une interaction intuitive (Ctrl+clic). Les hints visuels guident l'utilisateur sans surcharge d'interface.

**Impact Maintenabilit√©** : Architecture propre avec s√©paration des responsabilit√©s. Le mapping asset est fait c√¥t√© widget, permettant une int√©gration flexible avec les microflows Mendix. Les types TypeScript sont correctement mis √† jour.

**Impact Scalabilit√©** : La solution s'adapte automatiquement selon que le n≈ìud a des enfants ou non, √©vitant les clics inutiles sur les feuilles.

### üíú Prochaines √©tapes :
- Tester l'int√©gration avec les microflows Mendix
- Optionnel : ajouter un indicateur visuel (ic√¥ne) sur les n≈ìuds feuilles pour sugg√©rer la vue d√©taill√©e
- Consid√©rer l'ajout d'un double-clic comme alternative au Ctrl+clic

## 13 ao√ªt 2025 - Centrage SVG + Labels non chevauchants

### ‚åõ Changement :
- Ajout d'un `viewBox` et `preserveAspectRatio="xMidYMid meet"` sur le `<svg>` dans `SankeyChart` pour un viewport coh√©rent et un centrage fiable.
- Marges horizontales et verticales clamp√©es (8% de la largeur, born√©es √† 40‚Äì120 px; 24‚Äì80 px en hauteur) pour √©viter une zone vide excessive √† droite.
- Troncature mesur√©e c√¥t√© D3 des labels avec `getComputedTextLength()` et recherche binaire; masquage automatique si la hauteur du n≈ìud < 14 px.

### ü§î Analyse :
Ces ajustements alignent la largeur connue du layout D3 avec celle du viewport SVG (probl√®me observ√©: `svg width: 100%` vs `extent` trop √©troit). Le graphe est d√©sormais correctement centr√© et occupe mieux l'espace horizontal. Les labels ne se chevauchent plus gr√¢ce √† la troncature calcul√©e c√¥t√© D3 (les r√®gles CSS d'ellipsis sur `<text>` n'√©tant pas appliqu√©es par les navigateurs). L'impact est strictement visuel et am√©liore la lisibilit√© sans modifier la logique m√©tier.

### üíú Prochaines √©tapes :
- Optionnel: ajouter une routine d'anti-collision des labels (l√©ger d√©calage Y) pour les cas extr√™mes.
- Rendre la troncature et les seuils configurables via les props du widget.

### ‚åõ Changement additionnel (s√©curit√© donn√©es 0):
- Filtrage des liens de valeur 0 lors de la navigation et dans le rendu d3 (`useNavigationState` et `SankeyChart`) pour √©viter des √©tats D3 invalides et positions NaN.

### ü§î Analyse :
Certaines vues remontaient des liens √† 0 (ex: `USINE -> FACILITIES (0)`), ce qui peut conduire √† des layouts non d√©finis dans `d3-sankey`. En excluant ces liens non significatifs, on garantit la stabilit√© du calcul tout en conservant la lisibilit√©.

## 13 ao√ªt 2025 - UX Breadcrumb (suppression de la redondance √† l‚Äôouverture)

### ‚åõ Changement :
- Initialisation de la navigation directement sur la racine r√©elle si elle est identifiable (unique `level === 0` ou nom `ALIMENTATION PRINCIPALE`).
- Breadcrumb ajust√©: quand une racine r√©elle est pr√©sente, on n‚Äôaffiche pas le crumb "Vue d'ensemble" au d√©marrage.

### ü§î Analyse :
L‚Äôouverture montrait syst√©matiquement "Vue d'ensemble" puis, apr√®s clic, "Vue d'ensemble > ALIMENTATION PRINCIPALE > ‚Ä¶". Cette redondance brouille la lecture. En initialisant sur la racine r√©elle et en adaptant le breadcrumb, l‚Äôexp√©rience est plus logique: on commence directement au bon niveau.

### üíú Prochaines √©tapes :
- Rendre ce comportement configurable (prop: `startAtRealRoot: boolean`).

### ‚åõ Changement compl√©mentaire :
- Fallback synth√©tique des liens lors de la navigation si `links.length === 0` entre la racine courante et ses enfants: cr√©ation de liens epsilon pour √©viter un layout invalide et garder la lisibilit√©.

### ü§î Analyse :
Certaines branches reportent uniquement des valeurs 0 en premier niveau (USINE ‚Üí FACILITIES/PRODUCTION/SUPPORT). D3 ne positionne pas les n≈ìuds sans liens; le fallback construit des liens visuels bas√©s sur la somme entrante de chaque enfant (ou un epsilon), assurant un affichage stable.

## 13 ao√ªt 2025 - Anti-chevauchement labels/liens

### ‚åõ Changement :
- Placement des labels sur des ‚Äúpistes‚Äù gauche/droite hors des n≈ìuds, √† l‚Äôoppos√© des liens, avec connecteurs subtils.
- Troncature mesur√©e; √©vitement de collision vertical glouton pour maintenir les espacements.
- Retrait de l‚Äôarri√®re-plan pr√©c√©dent.

### ü§î Analyse :
Solution l√©g√®re, sans d√©pendances. Am√©liore la lisibilit√© dans les vues denses; peut √™tre √©tendu par un algorithme it√©ratif si besoin.

## 30 juin 2025 - Correction TypeScript d3-sankey Import

### ‚åõ Changement :
**Correction TypeScript** : R√©solution de l'erreur TypeScript `Property 'sankeyCenter' does not exist on type 'typeof import("d3")'` en utilisant l'import direct de `sankeyCenter` depuis `d3-sankey` au lieu de l'acc√®s via namespace `d3`.

### ü§î Analyse :
**Impact Maintenabilit√©** : Correction d'une erreur de type qui emp√™chait la compilation TypeScript. L'utilisation correcte des imports sp√©cifiques de `d3-sankey` am√©liore la clart√© du code et √©vite les confusions entre les diff√©rents modules D3.

### üîú Prochaines √©tapes :
- V√©rifier qu'aucune autre erreur TypeScript similaire n'existe dans le projet
- S'assurer que tous les imports D3 utilisent les modules appropri√©s

## 12 ao√ªt 2025 - Migration EnergyFlowNode en pr√©servant le visuel

### ‚åõ Changement :
- Int√©gration du nouveau backend EnergyFlowNode via `useVisualSankeyData` et `VisualDataAdapter`
- Refactor de `SankeyChart` (types explicites `VisualNode/VisualLink`, export par d√©faut) en conservant les classes CSS existantes (`sankey-node`, `sankey-link`, `sankey-label`, `sankey-chart`)
- Simplification de `AdvancedSankeyV2.tsx` pour consommer les donn√©es adapt√©es tout en gardant la structure DOM et les styles (`sankey-container`, `sankey-header`, etc.)

### ü§î Analyse :
- Maintenabilit√© : s√©paration nette donn√©es/affichage, adaptation unique EnergyFlowNode ‚Üí visuel. Le front reste stable et r√©utilisable.
- Scalabilit√© : types align√©s Mendix (`ListValue`, `ListAttributeValue`, `ValueStatus`) et calculs d3 isol√©s; la migration n‚Äôimpacte pas le CSS ni le layout.

### üîú Prochaines √©tapes :
- R√©introduire le breadcrumb et le DisplayModeSwitch (consommation/co√ªt) pour parit√© visuelle √† 100% selon le plan.
- Optionnel: remettre le tooltip portal (actuellement tooltip local conserv√©) si n√©cessaire.
- Lancer build complet et tests visuels pour v√©rifier identit√© du rendu.

## 16 juin 2025 - Suppression du Repository Git

### ‚åõ Changement :
**SUPPRESSION TRACKING GIT** : Suppression compl√®te du tracking git du dossier `advancedSankeyFinal` pour le transformer en dossier de d√©veloppement local non versionn√©.

**Actions effectu√©es** :
- Ajout de `advancedSankeyFinal/` au `.gitignore` du repository parent
- Suppression du dossier du cache git avec `git rm -r --cached advancedSankeyFinal`
- Commit des changements : "Remove advancedSankeyFinal from git tracking"
- Suppression des fichiers de configuration git locaux (`.gitignore`, `.gitattributes`, `.prettierignore`)

**Raison du changement** :
Le dossier `advancedSankeyFinal` √©tait track√© comme un submodule ou sous-dossier du repository principal, mais doit maintenant √™tre d√©velopp√© ind√©pendamment sans contr√¥le de version git.

### ü§î Analyse :
**Impact Maintenabilit√©** : La suppression du tracking git simplifie la gestion du projet en √©liminant les conflits potentiels de versioning entre le repository parent et le sous-projet. Le d√©veloppement devient plus flexible sans les contraintes de git.

**Impact Scalability** : Le projet peut maintenant √©voluer ind√©pendamment sans impacter le repository principal. Cette approche convient mieux pour un d√©veloppement rapide de prototype ou des exp√©rimentations.

### üîú Prochaines √©tapes :
1. Continuer le d√©veloppement sans contraintes git
2. √âvaluer si une r√©int√©gration git sera n√©cessaire √† terme
3. Maintenir la documentation d'avancement m√™me sans git

---

## 27 janvier 2025 - Correction Affichage Enfants de N≈ìuds Orphelins

### ‚åõ Changement :
**Correction Affichage des Enfants de N≈ìuds Orphelins** : R√©solution d'un bug majeur qui emp√™chait l'affichage correct des enfants lors de la navigation vers un n≈ìud orphelin. Les n≈ìuds enfants apparaissaient superpos√©s, sans liens.

### ü§î Analyse :
**Impact Fiabilit√©** : Cette correction assure que les liens hi√©rarchiques sont toujours valides, m√™me si les noms de donn√©es contiennent des variations. La navigation dans l'int√©gralit√© du graphe, y compris les branches orphelines, est maintenant robuste et fiable.

### üîú Prochaines √©tapes :
1.  Tester la navigation sur un jeu de donn√©es contenant des n≈ìuds orphelins avec des enfants pour valider la correction.
2.  S'assurer qu'aucun autre service ne construit des identifiants de mani√®re incoh√©rente.

---

## 27 janvier 2025 - Extension Support Hi√©rarchique (5 Niveaux)

### ‚åõ Changement :
**EXTENSION HI√âRARCHIE MULTI-NIVEAUX** : Ajout du support pour les hi√©rarchies √† 5 niveaux (0 √† 4) en r√©ponse √† une limitation configurative identifi√©e par l'utilisateur.

### ü§î Analyse :
**Impact Scalabilit√©** : Le widget peut maintenant g√©rer des structures organisationnelles plus complexes avec jusqu'√† 5 niveaux hi√©rarchiques. Cette extension r√©pond aux besoins d'entreprises ayant des structures plus profondes (Entreprise ‚Üí Division ‚Üí Site ‚Üí Atelier ‚Üí Machine ‚Üí √âquipement par exemple).

### üîú Prochaines √©tapes :
1. Tester la configuration avec des donn√©es r√©elles sur 5 niveaux
2. Valider que la r√®gle R3 fonctionne correctement avec les nouveaux attributs
3. Documenter les bonnes pratiques de configuration pour les hi√©rarchies profondes

---

## 26 janvier 2025 - Correction Crash Navigation (Donn√©es Invalides D3)

### ‚åõ Changement :
**CORRECTION CRASH CRITIQUE** : R√©solution d'un crash de type `invalid array length` qui se produisait dans la librairie D3 lors de la navigation vers un n≈ìud enfant.

### ü§î Analyse :
**Impact Fiabilit√©** : √âlimine un crash critique qui bloquait une fonctionnalit√© essentielle du widget (la navigation). La robustesse du rendu est grandement am√©lior√©e en garantissant que D3 ne re√ßoit que des donn√©es saines et coh√©rentes.

### üîú Prochaines √©tapes :
1.  Tester intensivement la navigation (mont√©e, descente, clics sur orphelins) pour s'assurer qu'aucun autre cas de crash ne subsiste.
2.  Valider la coh√©rence de l'affichage apr√®s plusieurs √©tapes de navigation.

---

## 26 janvier 2025 - Refactorisation du Rendu et Tri des N≈ìuds

### ‚åõ Changement :
**REFACTORISATION MAJEURE DU RENDU D3** : Correction des probl√®mes de centrage du diagramme et de l'organisation des n≈ìuds pour une lisibilit√© et une clart√© optimales.

### ü§î Analyse :
**Impact Maintenabilit√©** : La logique de rendu est consid√©rablement simplifi√©e. En supprimant la double gestion des positions (transformation + viewBox), le code est plus facile √† comprendre et √† maintenir. La logique de tri est centralis√©e et explicite.

### üîú Prochaines √©tapes :
1.  Confirmer que le tri des n≈ìuds est correct sur des jeux de donn√©es plus complexes.
2.  V√©rifier la r√©activit√© du `viewBox` lors du redimensionnement de la fen√™tre.

---

## 26 janvier 2025 - Am√©lioration du Rendu D3

### ‚åõ Changement :
**AM√âLIORATION DU RENDU VISUEL** : Ajustement de la logique de rendu D3 pour r√©soudre trois probl√®mes de mise en page signal√©s par l'utilisateur :

### ü§î Analyse :
**Impact Maintenabilit√©** : La logique de positionnement des libell√©s est maintenant plus simple et plus robuste. En se basant sur la position relative des n≈ìuds (`x0 < innerWidth / 2`), le code est plus d√©claratif et moins sujet aux erreurs de cas particuliers (comme pour les orphelins).

### üîú Prochaines √©tapes :
1.  Valider le rendu avec diff√©rents jeux de donn√©es pour s'assurer que les am√©liorations sont coh√©rentes.
2.  Monitorer les performances pour s'assurer que le nouvel alignement n'impacte pas le temps de rendu sur des diagrammes tr√®s larges.

---

## 25 janvier 2025 - Corrections Services Critiques (Multiple)

### ‚åõ Changement :
**CORRECTIONS MULTIPLES DE SERVICES** : R√©solution de probl√®mes critiques dans 4 services pour am√©liorer la robustesse et la conformit√© aux r√®gles m√©tier.

### ü§î Analyse :
**Impact Scalabilit√©** : √âlimination des risques de crash et des comportements non-d√©terministes. Les m√©canismes d'immutabilit√© permettent une m√©morisation React efficace m√™me avec de gros datasets.

### üîú Prochaines √©tapes :
1. Tests avec donn√©es r√©elles pour valider les corrections R3
2. V√©rification que la m√©morisation React fonctionne correctement
3. Validation des performances avec les nouveaux clonages immutables

---

## 25 janvier 2025 - Refactoring LinkRoutingService (R√®gle R5)

### ‚åõ Changement :
**REFACTORING COMPLET LINKROUTINGSERVICE** : Correction de 4 probl√®mes critiques dans le service de routage des liens selon la r√®gle R5 pour √©liminer les chevauchements et am√©liorer la stabilit√©.

### ü§î Analyse :
**Impact Scalabilit√©** : √âlimination des interf√©rences entre colonnes permet un passage √† l'√©chelle sans d√©gradation des performances de routage. Le syst√®me de cl√©s uniques √©vite les probl√®mes de croissance exponentielle.

### üîú Prochaines √©tapes :
1. Tester le routage avec donn√©es r√©elles multi-niveaux
2. Valider que les largeurs sont correctement appliqu√©es dans le rendu
3. V√©rifier que les contraintes de bornes √©liminent les d√©bordements

---

## 22 janvier 2025 - Correction Majeure R√®gle R4 (Filtrage d'Affichage)

### ‚åõ Changement :
**CORRECTION CRITIQUE SUPPL√âMENTAIRE** : Apr√®s test utilisateur, cinq probl√®mes majeurs identifi√©s et corrig√©s :

### ü§î Analyse :
**Root Cause Analysis Final** :
Le probl√®me fondamental √©tait une **incoh√©rence de logique d'initialisation** :
- **Orchestrateur** : `isInitialView = rootId === firstNodeId` (d√©tection par n≈ìud)
- **Hook D3** : `isRootView = selectedNode === rootNode` (d√©tection par s√©lection)

√Ä l'initialisation, `selectedNode = null` ‚Üí Hook D3 d√©tectait "navigation" au lieu de "vue initiale" !

**Impact Scalabilit√©** : Comportement d√©terministe garanti. Plus de diff√©rence entre premier rendu et clics suivants.

**Impact Maintainabilit√©** : Logique d'initialisation unifi√©e entre tous les services. Point de v√©rit√© unique pour "vue initiale".

**Comportement attendu maintenant** :
- **INITIALISATION** : `selectedNode=null` ‚Üí Usine + Atelier 1 + Machine 5 (TOUS VISIBLES d√®s le d√©but)
- **Navigation vers Atelier 1** : Atelier 1 + ETH 1 (PAS Machine 5)
- **Navigation vers ETH 1** : ETH 1 + Machine 1,2,3,4 (PAS Machine 5)

**Logs attendus** :
üéØ R4: rootId=Usine_Usine, selectedNode=null, firstNode=Usine_Usine, isInitial=true
üéØ D3: Vue racine - tous les n≈ìuds trait√©s comme connect√©s: 3
üîß D3: Configuration Sankey - n≈ìuds: 3 liens: 1
üè† R4: Orphelin ajout√©: Machine 5 - repositionn√© niveau 2
‚úÖ R6: Niveau 2 tri√©: Machine 5(20)

### üîú Prochaines √©tapes :
1. ‚úÖ Test compilation - OK
2. ‚úÖ **CORRECTION VALEURS RECALCUL√âES** : D3 Sankey recalcule automatiquement ‚Üí Restauration valeurs originales 
3. ‚úÖ **CORRECTION NAVIGATION** : Ajout logs debug pour identifier le blocage
4. ‚úÖ **CORRECTION NAVIGATION** : `hasChildren` utilise `allLinks` au lieu de `filteredLinks`
5. ‚úÖ **CORRECTION BREADCRUMB** : Toutes les m√©thodes utilisent `allLinks` pour navigation coh√©rente
6. ‚úÖ **OPTIMISATION TAILLE** : Widget plus compact pour tenir enti√®rement sur l'√©cran

**Optimisations compacit√© appliqu√©es** :
- **Dimensions** : `800x600` ‚Üí `600x400` par d√©faut pour tenir sur l'√©cran
- **nodeWidth** : `25-35px` ‚Üí `20-28px` avec ratio `0.025` ‚Üí `0.02`
- **nodePadding** : `15-24px` ‚Üí `8-12.8px` pour moins d'espacement entre n≈ìuds
- **orphanSpacing** : `35px` ‚Üí `25px` pour orphelins plus compacts
- **orphanStartY** : `+40px` ‚Üí `+20px` pour rapprocher les orphelins
- **Hauteur orphelins** : `20-30px` ‚Üí `18-25px` pour plus de compacit√©

**R√©sultat attendu** : Widget Sankey qui tient enti√®rement sur l'√©cran sans scroll, n≈ìuds plus proportionn√©s

**Am√©liorations responsivit√© D3 appliqu√©es** :
- **Fonction responsivefy** : SVG adaptatif avec `viewBox` et `preserveAspectRatio`
- **Dimensions compactes** : Max 500x300px avec Min 400x250px pour petit √©cran
- **Marges simplifi√©es** : `20px` top/bottom, `60px` left/right (au lieu de calcul√©es)
- **Syst√®me unifi√©** : Plus de double logique de dimensions entre fonctions
- **nodeWidth optimis√©** : `15-22px` avec ratio `0.04` sur largeur interne
- **nodePadding r√©duit** : `6-10px` fixe pour maximum de compacit√©
- **orphanSpacing ultra-compact** : `18px` avec nodeWidth `18px`

**Architecture responsivit√©** :
1. `makeResponsive()` : Adaptation automatique au conteneur parent
2. Dimensions compactes calcul√©es en amont (√©vite duplication)
3. SVG s'adapte via `viewBox` pour tous √©crans
4. Syst√®me de marges simplifi√© et optimis√©

**R√©sultat final attendu** : Widget vraiment responsive qui s'adapte automatiquement √† la taille du conteneur tout en restant lisible et compact

**üîß CORRECTION EFFET "ULTRA ZOOM√â"** :
- **Dimensions r√©ajust√©es** : Min 600x400px, Max 800x500px (au lieu de 500x300px)
- **Marges proportionnelles** : 30px top/bottom, 80px left/right pour plus d'espace
- **nodeWidth √©quilibr√©** : 20-35px avec ratio 0.06 (au lieu de 15-22px)
- **nodePadding g√©n√©reux** : 10-20px (au lieu de 6-10px)
- **orphanSpacing normal** : 30px avec nodeWidth 25px
- **makeResponsive am√©lior√©** : Limites 600-1200px pour √©viter zoom excessif
- **calculateOptimalHeight** : Max 500px (au lieu de 300px)

**Probl√®me r√©solu** : Le SVG ne devrait plus para√Ætre "ultra zoom√©" - les n≈ìuds auront une taille normale et proportionn√©e

**üîß NOUVELLE APPROCHE VIEWBOX DYNAMIQUE** :
- **Height SVG fixe** : 600px comme sugg√©r√© par l'utilisateur
- **ViewBox height calcul√©** : Bas√© sur le contenu r√©el du Sankey (bornes des n≈ìuds)
- **Centrage automatique** : ViewBox Y calcul√© pour centrer le contenu verticalement
- **Width responsive** : ViewBox width = largeur SVG, s'adapte au conteneur
- **preserveAspectRatio** : "xMidYMid meet" pour centrage sans d√©formation
- **Calcul post-rendu** : `calculateAndApplyViewBox()` apr√®s positionnement des n≈ìuds
- **Redimensionnement intelligent** : Pr√©servation du viewBox height lors du resize

**Architecture ViewBox** :
1. SVG cr√©√© avec width variable, height fixe 600px
2. Rendu complet des n≈ìuds D3 Sankey avec positions r√©elles
3. Calcul des bornes min/max X/Y du contenu
4. ViewBox ajust√© pour englober tout le contenu + marges
5. Centrage vertical automatique avec offset Y calcul√©

**R√©sultat attendu** : Widget qui s'adapte au conteneur tout en gardant le contenu Sankey bien centr√© et proportionn√© dans un viewBox optimal

**Corrections appliqu√©es (suite finale)** :
- **üîß VALEURS PR√âSERV√âES** : Apr√®s calcul D3 Sankey, restaurer `d3Node.value = originalNode.value`
- **üîß NAVIGATION DEBUGG√âE** : Logs `üñ±Ô∏è NAVIGATION:` pour tracer hasChildren/niveau/clic
- **üîß NAVIGATION CORRIG√âE** : `hasChildren` utilise `allLinks` au lieu de `filteredLinks`
- Root Cause valeurs : D3 Sankey recalcule selon liens entrants ‚Üí Force valeurs m√©tier originales
- Root Cause navigation : `hasChildren` cherchait dans vue actuelle ‚Üí Utilise maintenant TOUS les liens

**Changements techniques** :
- `SankeyContext` : Nouveau champ `allLinks: SimplifiedLink[]` pour navigation
- `SankeyOrchestrator.buildContext()` : Passe `energyFiltered.links` comme `allLinks`
- `NavigationService.hasChildren()` : Utilise `sankeyContext.allLinks` au lieu de `filteredLinks`
- **üîß BREADCRUMB CORRIG√â** : `buildNavigationPath()`, `canNavigateUp()`, `navigateUp()` utilisent `allLinks`
- **üîß ORCHESTRATEUR UNIFI√â** : Utilise `NavigationService.buildNavigationPath()` au lieu de `NodeSelectionService`
- Contextes par d√©faut : Ajout `allLinks: []` pour coh√©rence TypeScript

---

## 23 janvier 2025 - Affichage Badge Niveau 0

### ‚åõ Changement :
**AFFICHAGE BADGE NIVEAU OBLIGATOIRE** : Modification de l'affichage du badge de niveau pour qu'il soit toujours visible, y compris au niveau root (niveau 0).

### ü§î Analyse :
**Impact UX** : L'utilisateur a maintenant une indication claire de son niveau de navigation √† tout moment.

### üîú Prochaines √©tapes :
1. Test que le badge affiche bien "Niveau 0" au d√©marrage
2. Validation que la navigation affiche les bons niveaux (1, 2, etc.)

---

## 23 janvier 2025 - Correction √âcarts Extr√™mes de Valeurs (Normalisation Sankey)

### ü§î Analyse :
**Impact Scalabilit√©** : Plus de limitations par les √©carts de valeurs. Widget supporte maintenant TWh vs Wh.

**Impact Maintainabilit√©** : Normalisation transparente et automatique. Pas d'impact sur logique m√©tier.

**Impact UX** : Tous les n≈ìuds restent visibles et cliquables. Navigation fluide garantie.

### üîú Prochaines √©tapes :
1. Test avec donn√©es r√©elles extr√™mes (GWh vs kWh)
2. Validation tooltips affichent valeurs originales
3. V√©rification navigation avec n≈ìuds normalis√©s
4. ‚úÖ **CORRECTION PROPORTIONNALIT√â** : Algorithme de normalisation am√©lior√©

**üîß CORRECTION PROPORTIONNALIT√â VISUELLE** :
**Probl√®me identifi√©** : Atelier 1 (10 GWh) apparaissait de m√™me taille que Ateliers 2,3,4 (100 kWh) alors qu'il devrait √™tre 100 000√ó plus grand visuellement.

**Root Cause** : Normalisation logarithmique trop agressive (`Math.pow(10, normalizedLog / 10)`) √©galisait toutes les valeurs au lieu de pr√©server les proportions.

**Solution appliqu√©e** :
- **Transformation racine carr√©e** au lieu de log10 pour pr√©server mieux les proportions
- **√âcart cible r√©duit** : 50:1 au lieu de 100:1 pour √©viter les extr√™mes
- **Exposant d'ajustement** : `Math.pow(normalizedSqrt, 1.2)` pour courbe optimis√©e
- **Logs am√©lior√©s** : Affichage des ratios r√©els avant/apr√®s normalisation

**R√©sultat attendu** : Atelier 1 (10 GWh) sera maintenant visuellement plus grand que les autres ateliers tout en restant proportionn√©.

---

## 23 janvier 2025 - Adaptation Filtrage √ânergie Pr√©-Filtr√©

### ü§î Analyse :
**Impact Flexibilit√©** : Le widget supporte maintenant deux architectures :
1. **Filtrage en amont (recommand√©)** : Mendix filtre ‚Üí Widget traite directement
2. **Filtrage dans le widget** : Widget filtre selon `energyTypeAttribute`

**Impact Performance** : Mode pr√©-filtr√© plus performant (pas de recalcul hi√©rarchique inutile)

### üîú Prochaines √©tapes :
1. ‚úÖ Test du mode pr√©-filtr√© avec donn√©es utilisateur
2. ‚úÖ Validation que les 3 n≈ìuds attendus sont maintenant visibles
3. ‚úÖ V√©rification logs clarifi√©s pour diagnostic futur
4. **Prochaine session** : Tests approfondis et optimisations finales si n√©cessaire

---

## 23 janvier 2025 - Am√©lioration Affichage des Dates

### ü§î Analyse :
- **Impact UX** : Interface plus professionnelle et lisible en fran√ßais
- **Impact Maintainabilit√©** : Formatage centralis√© et r√©utilisable
- **Extensibilit√©** : Support futur pour d'autres langues via `Intl`

### üîú Prochaines √©tapes :
1. Test de l'affichage am√©lior√© des dates
2. Validation des diff√©rents styles sur diff√©rentes p√©riodes
3. √âventuel ajout de formatage relatif contextuel

---

## 23 janvier 2025 - Correction Largeur Liens Excessive

### ü§î Analyse :
Le probl√®me venait du fait que la largeur des liens √©tait uniquement contrainte par un minimum mais pas par un maximum relatif √† la taille des n≈ìuds. La solution applique une contrainte de 90% de la hauteur du plus petit n≈ìud (source ou target) comme largeur maximale pour les liens. Cette correction am√©liore significativement la lisibilit√© et la coh√©rence visuelle du diagramme Sankey.

### üîú Prochaines √©tapes :
- Tester avec diff√©rentes configurations de donn√©es
- Ajuster le pourcentage de contrainte (90%) si n√©cessaire
- Consid√©rer l'ajout d'un param√®tre configurable pour ce ratio

---

## 23 janvier 2025 - Nettoyage Imports et Configuration Prix Obligatoire

### ü§î Analyse :
**Impact Maintainabilit√©** : Code plus propre sans imports inutilis√©s. Configuration coh√©rente avec l'impl√©mentation du service.

**Impact Fiabilit√©** : Plus de risque de runtime errors dus √† des propri√©t√©s prix manquantes. L'utilisateur Mendix sera forc√© de configurer tous les champs n√©cessaires.

**Impact UX** : La fonctionnalit√© de prix sera maintenant garantie comme fonctionnelle, conform√©ment au requirement que "la feature de prix doit √™tre fonctionnel, ce n'est pas une future options, c'est mandatory".

### üîú Prochaines √©tapes :
1. Test de configuration du widget dans Mendix Studio Pro
2. Validation que tous les champs prix sont bien obligatoires
3. Test du calcul des prix avec les nouvelles contraintes

---

## 23 janvier 2025 - Corrections Architecture Hook D3

### ü§î Analyse :
**Impact Fiabilit√©** : Plus de runtime errors dues aux stale closures ou listeners orphelins. Widget compl√®tement pr√©visible.

**Impact Performance** : √âlimination des fuites m√©moire et listeners multiples. Scaling optimal en SPA.

**Impact Maintainabilit√©** : Architecture plus propre avec isolation des instances et lifecycle explicite. Code plus robuste pour les √©volutions futures.

**Impact Multi-instances** : Widgets totalement ind√©pendants, plus d'interf√©rences entre tooltips ou comportements.

### üîú Prochaines √©tapes :
1. Test avec plusieurs widgets sur m√™me page (validation multi-instances)
2. Test changements de props dynamiques (validation r√©activit√©)
3. Test navigation SPA avec montage/d√©montage (validation cleanup)

---

## 23 janvier 2025 - Correction Memory Leak Resize Listener

### ü§î Analyse :
**Impact Memory Management** : √âlimination compl√®te des fuites m√©moire. Chaque listener attach√© est garantie d'√™tre supprim√©.

**Impact Performance** : Plus d'accumulation de listeners multiples lors des redimensionnements. Performance stable en SPA.

**Impact Architecture** : Pattern de cleanup coh√©rent et explicite. Toutes les ressources externes (timers, listeners, DOM) nettoy√©es proprement.

**Impact Debugging** : Logs de cleanup pour tra√ßabilit√© des nettoyages lors du d√©veloppement.

### üîú Prochaines √©tapes :
1. Test d√©montage/remontage r√©p√©t√©s (validation cleanup complet)
2. Test resize multiples en SPA (validation performance)
3. Validation dans DevTools ‚Üí onglet Memory ‚Üí pas d'accumulation listeners

---

## 23 janvier 2025 - Optimisation Performance Hook FSM

### ü§î Analyse :
**Impact Performance** : √âlimination des re-renders inutiles. Widget ne re-traite les donn√©es que lors de vrais changements de contenu.

**Impact Memory Management** : Plus de fuites de listeners FSM. Lifecycle React parfaitement ma√Ætris√©.

**Impact Stabilit√©** : Comportement d√©terministe garanti. Plus de cascades de re-renders dues aux r√©f√©rences.

**Impact Developer Experience** : Pattern r√©utilisable pour stabiliser les d√©pendances complexes dans d'autres hooks.

### üîú Prochaines √©tapes :
1. Test avec props changeant souvent (validation optimisation)
2. Profiling React DevTools ‚Üí v√©rifier r√©duction re-renders
3. Test FSM transitions avec donn√©es identiques (pas de retraitement)

---

## 26 janvier 2025 - Affichage correct lors de la navigation vers un n≈ìud orphelin

### ü§î Analyse :
Le n≈ìud s√©lectionn√© comme racine (m√™me orphelin) est maintenant affich√© √† gauche avec ses enfants reli√©s. Les autres orphelins sont masqu√©s, respectant la r√®gle R4. L'exp√©rience de navigation est coh√©rente et lisible.

---

## 27 janvier 2025 - Correctif affichage des co√ªts

### ü§î Analyse :
Avec ces ajustements, le calcul des co√ªts s'active d√®s qu'un prix est disponible, m√™me quand les dates de la p√©riode ou la casse diff√®rent. Les libell√©s passent correctement de ¬´ kWh ¬ª/¬´ m¬≥ ¬ª √† ¬´ ‚Ç¨ ¬ª d√®s qu'une consommation non nulle est d√©tect√©e.

## 21 juin 2025 - Correction Critique Navigation - Liens Manquants

### ‚åõ Changement :
**CORRECTION CRITIQUE NAVIGATION-PROPORTIONNALIT√â** : R√©solution d√©finitive du probl√®me o√π les n≈ìuds perdaient leur proportionnalit√© lors de la navigation dans le Sankey.

**Cause racine identifi√©e** :
Dans `DisplayFilterService.filterVisibleNodes()`, seuls les **liens directs depuis la racine** √©taient retourn√©s :
```typescript
// AVANT (probl√©matique)
const directLinks = allLinks.filter(link => link.source === rootId);
return { nodes: visibleNodes, links: directLinks };
```

**Probl√®me** : En navigation (ex: clic sur "Traitement_thermique"), cette logique ne retournait que les liens o√π "Secteur_Traitement_thermique" est source, mais excluait tous les liens **entre les enfants visibles** (machines, √©quipements, etc.).

**R√©sultat** : `links.length === 0` ‚Üí D3 activait le mode "positionnement en grille" avec tailles fixes identiques ‚ùå

### üîß Solution Appliqu√©e :
```typescript
// APR√àS (correct)
const allRelevantLinks = allLinks.filter(link => {
  const sourceId = typeof link.source === 'string' ? link.source : link.source.id;
  const targetId = typeof link.target === 'string' ? link.target : link.target.id;
  
  // Inclure le lien si source ET target sont dans les n≈ìuds visibles
  return visibleNodeIds.has(sourceId) && visibleNodeIds.has(targetId);
});
```

**Logs de debug ajout√©s** :
- `üîç DEBUG LIENS: Total liens √† rendre: X`
- `üîß CORRECTION LIENS: Liens directs depuis racine: X, Tous liens pertinents: Y`

### ü§î Analyse :
Cette correction garantit que D3 Sankey re√ßoit **tous les liens pertinents** pour calculer les tailles proportionnelles des n≈ìuds et liens, exactement comme en vue root. La navigation conserve maintenant le m√™me rendu qualitatif que la page d'accueil.

### üîú Prochaines √©tapes :
- Tester la navigation sur diff√©rents niveaux
- Valider que les proportions sont coh√©rentes
- Nettoyer les logs de debug si confirm√©

---

## 21 juin 2025 - Correction Proportionnalit√© Tailles lors Navigation

## üóìÔ∏è 2025-01-27

### ‚åõ Changement : Am√©lioration critique de la gestion des vues denses dans le rendu D3

**Probl√®me identifi√©** : Les n≈ìuds et liens perdaient leurs proportions dans les vues avec beaucoup d'√©l√©ments (12+ n≈ìuds), passant en mode "dimensions par d√©faut" au lieu de conserver les proportions bas√©es sur les valeurs.

**Solutions impl√©ment√©es** :

1. **Adaptation dynamique des dimensions du canvas** :
   - Facteur de densit√© bas√© sur le nombre de n≈ìuds
   - Augmentation automatique des dimensions pour les vues complexes
   - Canvas jusqu'√† 2000x1200px pour les vues tr√®s denses

2. **Configuration D3 Sankey adaptative** :
   - `nodeWidth` et `nodePadding` calcul√©s selon la densit√©
   - Facteur inverse : plus de n≈ìuds = dimensions plus compactes mais proportionnelles
   - √âpaisseur des liens adapt√©e (1.5-15px selon contexte)

3. **Marges et espacements intelligents** :
   - Marges qui s'agrandissent avec le nombre de n≈ìuds
   - Calcul dynamique des espaces pour les labels

4. **Rendu visuel optimis√©** :
   - Police adaptative (14-20px selon densit√©)
   - Troncature intelligente des labels longs
   - Pr√©servation des proportions visuelles

### ü§î Analyse :

Cette am√©lioration r√©sout un probl√®me critique d'utilisabilit√© o√π le widget devenait illisible dans les vues complexes. L'approche adaptative garantit :
- **Scalabilit√©** : Fonctionne de 3 √† 20+ n≈ìuds
- **Maintien des proportions** : Les valeurs restent visuellement comparables
- **Lisibilit√©** : Labels et dimensions s'adaptent automatiquement
- **Performance** : Pas de calculs lourds suppl√©mentaires

### üîú Prochaines √©tapes :
- Tester avec des datasets tr√®s larges (30+ n≈ìuds)
- Ajouter un mode "zoom out" automatique si n√©cessaire
- Optimiser la d√©tection des cas o√π un scroll devient n√©cessaire

---

## üóìÔ∏è 2025-01-26

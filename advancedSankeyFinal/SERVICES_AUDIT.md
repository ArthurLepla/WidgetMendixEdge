# üîç AUDIT COMPLET DES SERVICES & ARCHITECTURE

## üìä **√âTAT ACTUEL DES SERVICES**

### ‚úÖ **SERVICES PROPRES ET CONFORMES**

#### 1. **ParentCalculationService** ‚≠ê *EXCELLENT*
```typescript
‚úÖ Responsabilit√© unique: Calcul parent direct selon R3
‚úÖ API claire: findDirectParent(), hasConvergence()
‚úÖ Gestion erreurs: null si pas de parent, logs debug
‚úÖ R√âCEMMENT CORRIG√â: Support niveau 3 (Machine)
```

#### 2. **NodeSelectionService** ‚≠ê *EXCELLENT*
```typescript
‚úÖ Responsabilit√© unique: S√©lection racine selon R2
‚úÖ API claire: findInitialRoot(), setNewRoot()
‚úÖ Logique m√©tier encapsul√©e
‚úÖ Navigation path pour breadcrumbs
```

#### 3. **DisplayFilterService** ‚≠ê *EXCELLENT*
```typescript
‚úÖ Responsabilit√© unique: Filtrage affichage selon R4
‚úÖ API claire: filterVisibleNodes(), canNavigateUp()
‚úÖ Validation conformit√© R4 int√©gr√©e
‚úÖ Gestion profondeur configurable
```

#### 4. **NodeSortingService** ‚≠ê *EXCELLENT*
```typescript
‚úÖ Responsabilit√© unique: Tri selon R6
‚úÖ Logique poids descendant + alphab√©tique
‚úÖ Validation conformit√© R6
‚úÖ Debug utilities (logNodeOrder)
```

### üîÑ **SERVICES PARTIELLEMENT IMPL√âMENT√âS**

#### 5. **LinkRoutingService** ‚ö†Ô∏è *INCOMPLET*
```typescript
‚úÖ Structure correcte pour R5
‚ö†Ô∏è Int√©gration D3 manquante
‚ö†Ô∏è Chemin SVG pas utilis√© dans rendu
üîß ACTION: Int√©grer paths calcul√©s dans D3
```

#### 6. **OverlapPreventionService** ‚ö†Ô∏è *INCOMPLET*
```typescript
‚úÖ D√©tection chevauchements fonctionnelle
‚ö†Ô∏è Correction overlaps non impl√©ment√©e
‚ö†Ô∏è Validation R7 basique
üîß ACTION: Impl√©menter adjustLinksToReduceOverlap()
```

### ‚ö†Ô∏è **SERVICES √Ä AM√âLIORER**

#### 7. **SankeyDataService** üîß *BASIQUE*
```typescript
‚ö†Ô∏è Responsabilit√©s multiples
‚ö†Ô∏è Pas de coordonnation avec autres services
‚ö†Ô∏è Transformation D3 s√©par√©e du m√©tier
üîß ACTION: Refactoring ou suppression
```

---

## üö® **PROBL√àME MAJEUR: COMPOSANT MONOLITHIQUE**

### üìè **METRICS ALARMANTS**
- **2271 lignes** dans AdvancedSankeyV2.tsx
- **300+ lignes** de logique m√©tier dans useEffect
- **5 responsabilit√©s** dans 1 composant
- **0 s√©paration** logique m√©tier / rendu

### üî¥ **VIOLATIONS ARCHITECTURE CLEAN**

#### **Violation 1: Logique m√©tier dans composant**
```typescript
// ‚ùå MAUVAIS: 300+ lignes dans useEffect
useEffect(() => {
  // Cr√©ation n≈ìuds
  // Cr√©ation liens  
  // Filtrage √©nergie
  // Tri
  // √âtat FSM
  // Gestion navigation
}, [deps]);
```

#### **Violation 2: Multiple responsabilit√©s**
```typescript
export function AdvancedSankeyV2() {
  // ‚ùå Responsabilit√© 1: Logique m√©tier
  // ‚ùå Responsabilit√© 2: Gestion √©tat FSM
  // ‚ùå Responsabilit√© 3: Navigation
  // ‚ùå Responsabilit√© 4: Rendu D3
  // ‚ùå Responsabilit√© 5: Gestion tooltips
}
```

#### **Violation 3: Double filtrage √©nergie**
```typescript
// ‚ùå CONFLIT: 2 endroits font la m√™me chose
// 1. Ligne ~376 dans useEffect principal
if (props.selectedEnergies !== "all") { /* logique complexe */ }

// 2. Ligne ~346 dans filterDataForView()  
const filteredByEnergy: SankeyData = data;
```

---

## üéØ **SOLUTIONS RECOMMAND√âES**

### üöÄ **SOLUTION 1: Service Coordinateur**

```typescript
// NOUVEAU: src/services/SankeyOrchestrator.ts
export class SankeyOrchestrator {
  
  /**
   * Point d'entr√©e unique pour traitement complet des donn√©es
   */
  static processHierarchicalData(
    hierarchyConfig: HierarchyConfigType[],
    selectedEnergy: string,
    selectedNode: string | null,
    startDate?: Date,
    endDate?: Date
  ): SankeyProcessingResult {
    
    const startTime = performance.now();
    
    try {
      // 1. Cr√©ation n≈ìuds avec validation
      const nodes = this.createValidatedNodes(hierarchyConfig, startDate, endDate);
      
      // 2. Cr√©ation liens avec ParentCalculationService
      const links = this.createHierarchicalLinks(nodes, hierarchyConfig);
      
      // 3. Filtrage √©nergie unifi√©
      const energyFiltered = this.applyEnergyFilter(nodes, links, selectedEnergy);
      
      // 4. S√©lection racine avec NodeSelectionService
      const rootId = selectedNode || NodeSelectionService.findInitialRoot(energyFiltered.nodes);
      
      // 5. Filtrage affichage avec DisplayFilterService
      const displayed = DisplayFilterService.filterVisibleNodes(
        energyFiltered.nodes, 
        rootId!, 
        energyFiltered.links, 
        1
      );
      
      // 6. Tri avec NodeSortingService
      const sorted = NodeSortingService.sortAllLevels(displayed.nodes);
      
      // 7. Routage liens avec LinkRoutingService (si activ√©)
      const routedLinks = this.applyLinkRouting(displayed.links, sorted);
      
      // 8. Validation finale conformit√©
      const validation = this.validateAllRules(sorted, routedLinks);
      
      const endTime = performance.now();
      
      return {
        success: true,
        data: { nodes: sorted, links: routedLinks, levels: [] },
        state: this.determineState(rootId, sorted),
        context: this.buildContext(rootId!, energyFiltered.nodes, displayed.links),
        validation,
        performance: {
          duration: endTime - startTime,
          nodeCount: sorted.length,
          linkCount: routedLinks.length
        }
      };
      
    } catch (error) {
      return {
        success: false,
        error: error.message,
        state: SankeyState.Error,
        context: this.buildErrorContext(error)
      };
    }
  }
  
  /**
   * M√©thodes priv√©es pour chaque √©tape
   */
  private static createValidatedNodes(config: HierarchyConfigType[], startDate?: Date, endDate?: Date) {
    // Logique extraction depuis useEffect actuel
  }
  
  private static createHierarchicalLinks(nodes: ExtendedNode[], config: HierarchyConfigType[]) {
    // Utilise ParentCalculationService.findDirectParent()
  }
  
  private static applyEnergyFilter(nodes: ExtendedNode[], links: any[], energy: string) {
    // UNIFIE les 2 filtrages actuels en 1 seul
  }
  
  private static validateAllRules(nodes: ExtendedNode[], links: any[]) {
    // Appelle tous les validateRXCompliance()
  }
}
```

### üöÄ **SOLUTION 2: Refactoring Composant Principal**

```typescript
// NOUVEAU: src/AdvancedSankeyV2.tsx (VERSION PROPRE)
export function AdvancedSankeyV2(props: AdvancedSankeyV2ContainerProps): ReactElement {
  
  // üéØ √âTAT MINIMAL - Seulement les donn√©es finales
  const [processingResult, setProcessingResult] = useState<SankeyProcessingResult | null>(null);
  const [dimensions, setDimensions] = useState({ width: 0, height: 600 });
  const [displayMode, setDisplayMode] = useState<DisplayMode>("consumption");
  
  // üéØ EFFET UNIQUE - D√©l√®gue tout √† l'orchestrateur
  useEffect(() => {
    const result = SankeyOrchestrator.processHierarchicalData(
      props.hierarchyConfig,
      props.selectedEnergies,
      props.selectedNode,
      props.startDate?.value,
      props.endDate?.value
    );
    
    setProcessingResult(result);
  }, [props.hierarchyConfig, props.selectedEnergies, props.selectedNode, props.startDate, props.endDate]);
  
  // üéØ GESTION ERREURS PROPRE
  if (!processingResult) {
    return <SankeyLoading />;
  }
  
  if (!processingResult.success) {
    return <SankeyError error={processingResult.error} />;
  }
  
  if (!processingResult.data || processingResult.data.nodes.length === 0) {
    return <SankeyNoData period={{ start: props.startDate?.value, end: props.endDate?.value }} />;
  }
  
  // üéØ RENDU MODULAIRE
  return (
    <SankeyContainer ref={containerRef}>
      <SankeyHeader 
        title={props.title}
        energyType={props.selectedEnergies}
        displayMode={displayMode}
        onDisplayModeChange={setDisplayMode}
        period={{ start: props.startDate?.value, end: props.endDate?.value }}
      />
      
      <SankeyBreadcrumbs 
        navigationPath={processingResult.context.navigationPath}
        onNavigate={(nodeId) => props.onNodeSelect?.(nodeId)}
      />
      
      <SankeyChart
        data={processingResult.data}
        dimensions={dimensions}
        displayMode={displayMode}
        onNodeClick={handleNodeClick}
        priceConfig={extractPriceConfig(props)}
      />
      
      {props.showDebugTools && (
        <SankeyDebugPanel 
          validation={processingResult.validation}
          performance={processingResult.performance}
        />
      )}
    </SankeyContainer>
  );
}
```

### üöÄ **SOLUTION 3: Composants Modulaires**

```typescript
// src/components/SankeyContainer.tsx
export const SankeyContainer = forwardRef<HTMLDivElement, SankeyContainerProps>(() => {
  // Gestion dimensions + resize observer
});

// src/components/SankeyChart.tsx  
export const SankeyChart: React.FC<SankeyChartProps> = ({ data, dimensions, onNodeClick }) => {
  // SEULEMENT le rendu D3 pur
  const svgRef = useRef<SVGSVGElement>(null);
  
  useD3Rendering(svgRef, data, dimensions, onNodeClick);
  
  return <svg ref={svgRef} />;
};

// src/components/SankeyHeader.tsx
export const SankeyHeader: React.FC<SankeyHeaderProps> = ({ title, energyType, displayMode, onDisplayModeChange }) => {
  // SEULEMENT l'UI header
};

// src/components/SankeyBreadcrumbs.tsx
export const SankeyBreadcrumbs: React.FC<SankeyBreadcrumbsProps> = ({ navigationPath, onNavigate }) => {
  // SEULEMENT la navigation
};
```

---

## üìã **PLAN D'ACTION RECOMMAND√â**

### üî• **PHASE 1 - URGENT (1-2 jours)**
1. ‚úÖ **ParentCalculationService d√©j√† corrig√©**
2. üîß **Cr√©er SankeyOrchestrator** - Extraire logique useEffect
3. üîß **Tester avec donn√©es existantes** - Pas de r√©gression

### üöÄ **PHASE 2 - ARCHITECTURE (3-5 jours)**  
4. üîß **Refactorer composant principal** - Version lean
5. üîß **Cr√©er composants modulaires** - SankeyChart, SankeyHeader, etc.
6. üîß **Int√©grer LinkRoutingService** - Paths SVG dans D3
7. üîß **Compl√©ter OverlapPreventionService** - R7 full

### üéØ **PHASE 3 - OPTIMISATION (2-3 jours)**
8. üîß **Tests unitaires services** - Couverture 90%
9. üîß **Tests int√©gration orchestrateur** - Sc√©narios complets  
10. üîß **Performance monitoring** - M√©triques + alertes

---

## üéØ **B√âN√âFICES ATTENDUS**

### üìà **MAINTENABILIT√â**
- **2271 ‚Üí ~300 lignes** composant principal
- **Responsabilit√© unique** par module
- **Tests unitaires** possibles sur services

### üöÄ **PERFORMANCE**  
- **Logique m√©tier optimis√©e** dans orchestrateur
- **Rendu D3 s√©par√©** et r√©utilisable
- **Memoization** possible sur services purs

### üîß **D√âVELOPPEMENT**
- **Debugging facilit√©** avec services isol√©s
- **Nouvelles fonctionnalit√©s** plus rapides √† ajouter
- **Regression testing** robuste

### üèóÔ∏è **ARCHITECTURE**
- **Clean Architecture** respect√©e
- **SOLID principles** appliqu√©s  
- **FSM** properly managed
- **Services coordonn√©s** via orchestrateur

**VERDICT: Vos services sont EXCELLENTS mais le composant principal DOIT √™tre refactoris√© d'urgence !** 
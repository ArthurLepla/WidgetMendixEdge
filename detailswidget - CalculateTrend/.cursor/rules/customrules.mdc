---
description:
globs:
alwaysApply: false
---
# Cursor Rule (v3)

You are a **senior software engineer** specialized in building highlyâ€‘scalable and maintainable systems.

> **RÃ¨gle d'Or**Â : *Met Ã  jour le fichier `avancement.md` aprÃ¨s **chaque** changement de code ou de documentation de faÃ§on Ã  tracer l'avancement et les apprentissages.*

---

## 1Â Â· Engineering Principles

### 1.1Â Modelâ€‘Driven Development with **Finiteâ€‘State Machines (FSMs)**

* Model every nonâ€‘trivial workflowâ€”API request lifecycle, background job, UI wizard, IoT device lifeâ€‘cycleâ€”as an explicit FSM.
* Keep **states** canonical and enumerated in a dedicated module (`states.ts` / `states.py`).
* Define **transitions** as pure, sideâ€‘effectâ€‘free functions `(state, event) â nextState | Error`.
* Reject invalid transitions aggressively and fail fast.
* Treat state objects as **immutable**; return a new object on every transition. This enables timeâ€‘travel debugging and event sourcing.
* Persist state diagrams (Mermaid, PlantUML) under `/docs/stateâ€‘diagrams/` and link them from code.
* Achieve **100â€¯% transition coverage** with unit tests; adopt propertyâ€‘based tests for guard conditions.
* For UIs, prefer libraries such as **XState** (React) or **robot3** (Vue/Svelte) to guarantee determinism.

### 1.2Â Function & File Sizing

* Split files >400Â LOC or functions >40Â LOC. Favour *small, pure, intentionâ€‘revealing* functions.

### 1.3Â ImmutabilityÂ â€¢Â Pure Functions

* Default to pure functions; isolate sideâ€‘effects behind clearlyâ€‘named adapters (e.g. `GitHubClient`, `SqlRepository`).

### 1.4Â Observability & Telemetry

* Add structured logs at **every** state transition and external boundary. Correlate with a requestÂ / traceÂ ID.
* Expose health probes, histograms, and tracing spans (OpenTelemetry) by default.

### 1.5Â Architecture Patterns

* Prefer **Hexagonal / Clean Architecture**â€”domain logic in the centre, adapters at the edge.
* Compose behaviour; avoid deep inheritance.
* Apply **CQRS + Event Sourcing** where complex state history or auditability is required.

---

## 2Â Â· Coding Guidelines (updated)

* Strong typing everywhere (TypeScript, Python `typing`, etc.).
* Dependency injection via interfaces; avoid service locators.
* Maintain â°90Â %â± unitâ€‘test line coverage on business logic.
* Document **tradeâ€‘offs** inline when deviating from guidelines.
* After writing code, produce a **1â€‘2 paragraph retrospective** (see template below) and append a link in `avancement.md`.

---

## 3Â Â· Retrospective Template

```md
### âŒ› ChangementÂ :
<rÃ©sumÃ© court>

### ğŸ¤” AnalyseÂ :
<impact scalability & maintainability>

### ğŸ”œ Prochaines Ã©tapesÂ :
<todo, refacto, debt>
```

---

## 4Â Â· Planner Mode (refonte)

1. Analyse la demande.
2. Pose **4â€‘6 questions de clarification** â€” y compris les impacts sur FSMÂ / Ã©tats.
3. RÃ©dige un **plan complet** incluantâ€¯:

   * migrations d'Ã©tat ou nouveaux diagrammes FSM;
   * impact sur modules, tests, docs.
4. Demande mon approbation.
5. Une fois approuvÃ©, **implÃ©mente chaque Ã©tape** et, aprÃ¨s chaque phaseÂ :

   * indique ce qui vient d'Ãªtre faitâ€¯;
   * rappelle les Ã©tapes restantes.

---

## 5Â Â· Architecture Mode (refonte)

* Applique le mÃªme workflow que Planner Mode mais avecÂ :

  * **5â€¯paragraphes d'analyse de compromis** (scale, perf, coÃ»ts, simplicitÃ©â€¦)
  * Questions de clarification (4â€‘6) orientÃ©es volumÃ©trie et invariants d'Ã©tat.
  * Design dÃ©taillÃ© (diagrammes FSM, schÃ©mas de dÃ©ploiement, ADRs).

---

## 6Â Â· Debugger Mode (complÃ©ments FSM)

* Lorsque le systÃ¨me repose sur un FSM, journalise toujoursÂ `currentState`, `event`, `nextState`.
* Ajoute des assertions sur les transitions invalides.
* Respecte la sÃ©quence existanteÂ (7Â Ã©tapes) et, aprÃ¨s correction, **demande l'autorisation** de retirer les logs.

---

## 7Â Â· Pull Requests & Commits

* VÃ©rifie `git status` pour confirmer les fichiers changÃ©s.
* Un commit par groupe logique ou fichier significatif.
* Message de PRÂ : **une seule ligne** sans saut de ligne.

---

# UI/UX Guidelines v8 - Ark UI Integration

## 8.0 Core Principles â€“ Â« Less but Smarter Â»

* **UI au service de l'UX** : clartÃ©, cohÃ©rence, feedback rapide
* **HiÃ©rarchie des bibliothÃ¨ques** : Ark UI â†’ Lucide React â†’ TypeScript â†’ Framer Motion â†’ Ant Design (dernier recours)
* **Chaque rÃ¨gle est non-nÃ©gociable** sauf justification ADR
* **Composants headless** : privilÃ©gier la flexibilitÃ© et la customisation

## 8.1 Ark UI - BibliothÃ¨que Principale

### 8.1.1 Philosophie Ark UI
* **Headless components** : logique sans style imposÃ©
* **AccessibilitÃ© native** : WCAG 2.2 AA par dÃ©faut
* **Composition over inheritance** : utiliser `asChild` pour Ã©tendre
* **Ã‰tat managÃ©** : Context/Provider pour coordination inter-composants

### 8.1.2 Architecture des Composants

```typescript
// Structure recommandÃ©e pour widgets Mendix
interface WidgetProps {
  // Ark UI props
  arkProps?: Record<string, any>
  // DonnÃ©es mÃ©tier
  data?: DataContract
  // Configuration visuelle
  theme?: ThemeConfig
  // Callbacks Mendix
  onAction?: (action: string, params?: any) => void
}

// Pattern de composition avec Ark UI
const MyWidget = ({ arkProps, data, theme, onAction }: WidgetProps) => {
  return (
    <ArkComponent.Root {...arkProps}>
      <ArkComponent.Context>
        {(context) => (
          <ArkComponent.Content>
            {/* Logique mÃ©tier */}
          </ArkComponent.Content>
        )}
      </ArkComponent.Context>
    </ArkComponent.Root>
  )
}
```

### 8.1.3 Collections et DonnÃ©es

```typescript
// Utilisation des collections Ark UI
import { createListCollection } from '@ark-ui/react/collection'

const createWidgetCollection = (mendixData: MendixObject[]) => {
  return createListCollection({
    items: mendixData,
    itemToValue: (item) => item.guid,
    itemToString: (item) => item.getValue('displayName'),
    isItemDisabled: (item) => !item.getValue('isActive')
  })
}

// Pour donnÃ©es hiÃ©rarchiques
const createTreeCollection = (treeData: TreeNode[]) => {
  return createTreeCollection({
    rootNode: treeData,
    nodeToValue: (node) => node.id,
    nodeToString: (node) => node.label,
    nodeToChildren: (node) => node.children
  })
}
```

### 8.1.4 Styling avec Ark UI

```typescript
// Data attributes pour styling
const StyledComponent = () => (
  <ArkComponent.Root className="widget-root">
    <ArkComponent.Item 
      className="widget-item"
      data-state="active"
      data-scope="mendix-widget"
      data-part="item"
    >
      {/* Contenu */}
    </ArkComponent.Item>
  </ArkComponent.Root>
)

// CSS correspondant
/*
[data-scope='mendix-widget'][data-part='item'] {
  /* Styles de base */
}

[data-scope='mendix-widget'][data-part='item'][data-state='active'] {
  /* Styles Ã©tat actif */
}
*/
```

## 8.2 IntÃ©gration TypeScript

### 8.2.1 Types Ark UI
```typescript
// Extension des types Ark UI
interface ExtendedArkProps extends ArkComponent.RootProps {
  mendixContext?: MendixContext
  widgetId?: string
  customConfig?: WidgetConfig
}

// Wrapper typÃ©
const TypedArkComponent = <T extends ExtendedArkProps>(
  props: T
): JSX.Element => {
  const { mendixContext, widgetId, customConfig, ...arkProps } = props
  
  return (
    <ArkComponent.Root {...arkProps}>
      {/* ImplÃ©mentation */}
    </ArkComponent.Root>
  )
}
```

### 8.2.2 Validation de Props
```typescript
// Validation runtime avec Zod
import { z } from 'zod'

const WidgetPropsSchema = z.object({
  data: z.array(z.object({
    guid: z.string(),
    displayName: z.string(),
    isActive: z.boolean()
  })),
  theme: z.object({
    variant: z.enum(['primary', 'secondary', 'danger']),
    size: z.enum(['sm', 'md', 'lg'])
  }).optional()
})

type WidgetProps = z.infer<typeof WidgetPropsSchema>
```

## 8.3 IcÃ´nes avec Lucide React

### 8.3.1 Utilisation Standard
```typescript
import { 
  ChevronDown, 
  User, 
  Settings, 
  AlertCircle,
  CheckCircle 
} from 'lucide-react'

// Composant icÃ´ne standardisÃ©
interface IconProps {
  icon: LucideIcon
  size?: 'sm' | 'md' | 'lg'
  variant?: 'default' | 'success' | 'warning' | 'error'
}

const Icon = ({ icon: IconComponent, size = 'md', variant = 'default' }: IconProps) => (
  <IconComponent 
    size={size === 'sm' ? 16 : size === 'md' ? 20 : 24}
    className={`icon icon--${variant}`}
  />
)
```

### 8.3.2 IntÃ©gration avec Ark UI
```typescript
// IcÃ´nes contextuelles dans Ark UI
const SelectWithIcon = () => (
  <Select.Root>
    <Select.Trigger>
      <Select.ValueText placeholder="SÃ©lectionner..." />
      <Select.Indicator>
        <ChevronDown size={16} />
      </Select.Indicator>
    </Select.Trigger>
    <Select.Content>
      <Select.Item value="option1">
        <User size={16} />
        <Select.ItemText>Option 1</Select.ItemText>
      </Select.Item>
    </Select.Content>
  </Select.Root>
)
```

## 8.4 Animations avec Framer Motion

### 8.4.1 Animations Ark UI
```typescript
import { motion } from 'framer-motion'

// Wrapper motion pour composants Ark UI
const AnimatedArkComponent = ({ children, ...props }) => (
  <ArkComponent.Root asChild {...props}>
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -20 }}
      transition={{ duration: 0.2 }}
    >
      {children}
    </motion.div>
  </ArkComponent.Root>
)
```

### 8.4.2 Animations d'Ã‰tat
```typescript
// Animations basÃ©es sur l'Ã©tat Ark UI
const AnimatedTooltip = () => {
  const [isOpen, setIsOpen] = useState(false)
  
  return (
    <Tooltip.Root open={isOpen} onOpenChange={setIsOpen}>
      <Tooltip.Trigger>Hover me</Tooltip.Trigger>
      <Tooltip.Content asChild>
        <motion.div
          initial={{ opacity: 0, scale: 0.8 }}
          animate={{ 
            opacity: isOpen ? 1 : 0, 
            scale: isOpen ? 1 : 0.8 
          }}
          transition={{ duration: 0.15 }}
        >
          Tooltip content
        </motion.div>
      </Tooltip.Content>
    </Tooltip.Root>
  )
}
```

## 8.5 Widget Mendix avec Ark UI

### 8.5.1 Structure du Widget
```typescript
interface MendixWidgetProps {
  // Props Mendix standard
  class?: string
  style?: CSSProperties
  tabIndex?: number
  
  // Props mÃ©tier
  dataSource?: ListValue
  onSelectionChange?: ActionValue
  
  // Configuration Ark UI
  arkConfig?: {
    variant?: string
    size?: string
    disabled?: boolean
  }
}

const MendixArkWidget = (props: MendixWidgetProps) => {
  const { class: className, style, dataSource, onSelectionChange, arkConfig } = props
  
  // Collection Ark UI depuis donnÃ©es Mendix
  const collection = useMemo(() => {
    if (!dataSource?.items) return createListCollection({ items: [] })
    
    return createListCollection({
      items: dataSource.items,
      itemToValue: (item) => item.id,
      itemToString: (item) => item.getValue('displayName') as string,
      isItemDisabled: (item) => !item.getValue('isSelectable') as boolean
    })
  }, [dataSource?.items])
  
  return (
    <div className={className} style={style}>
      <ArkComponent.Root 
        collection={collection}
        onSelectionChange={(details) => {
          onSelectionChange?.execute()
        }}
        {...arkConfig}
      >
        {/* ImplÃ©mentation du widget */}
      </ArkComponent.Root>
    </div>
  )
}
```

### 8.5.2 Gestion des Ã‰tats
```typescript
// Hook pour gÃ©rer l'Ã©tat du widget
const useWidgetState = (initialData: any[]) => {
  const [data, setData] = useState(initialData)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  
  const collection = useMemo(() => 
    createListCollection({
      items: data,
      itemToValue: (item) => item.id,
      itemToString: (item) => item.name
    }), [data])
  
  return {
    data,
    setData,
    loading,
    setLoading,
    error,
    setError,
    collection
  }
}
```

## 8.6 Composants Ark UI Disponibles

### 8.6.1 Composants de Base
- **Avatar** : Photos de profil avec fallback
- **Badge** : Indicateurs d'Ã©tat
- **Button** : Actions primaires/secondaires
- **Card** : Conteneurs de contenu
- **Separator** : SÃ©parateurs visuels

### 8.6.2 Composants d'Input
- **Checkbox** : SÃ©lection multiple
- **Input** : Champs de texte
- **NumberInput** : Champs numÃ©riques
- **PinInput** : Saisie de codes
- **RadioGroup** : SÃ©lection unique
- **Select** : Listes dÃ©roulantes
- **Slider** : SÃ©lection de valeurs
- **Switch** : Interrupteurs binaires
- **TextArea** : Texte multiligne

### 8.6.3 Composants de Navigation
- **Breadcrumb** : Fil d'Ariane
- **Menu** : Menus contextuels
- **Pagination** : Navigation de pages
- **Tabs** : Onglets
- **TreeView** : Arborescence

### 8.6.4 Composants de Feedback
- **Alert** : Messages d'alerte
- **Dialog** : BoÃ®tes de dialogue
- **Popover** : Contenus flottants
- **Toast** : Notifications temporaires
- **Tooltip** : Infobulles

### 8.6.5 Composants de DonnÃ©es
- **Accordion** : Sections repliables
- **Calendar** : SÃ©lection de dates
- **Carousel** : DÃ©filement de contenu
- **Combobox** : SÃ©lection avec recherche
- **DataList** : Listes de donnÃ©es
- **Table** : Tableaux de donnÃ©es

## 8.7 Fallback vers Ant Design

### 8.7.1 CritÃ¨res d'Utilisation
Utiliser Ant Design **uniquement** si :
- Composant non disponible dans Ark UI
- Contrainte de temps critique
- FonctionnalitÃ© spÃ©cifique requise

### 8.7.2 Migration Progressive
```typescript
// Wrapper pour migration progressive
const LegacyAntComponent = ({ useArkUI = true, ...props }) => {
  if (useArkUI && isArkUIAvailable) {
    return <ArkEquivalent {...props} />
  }
  return <AntDesignComponent {...props} />
}
```

## 8.8 Performance et Optimisation

### 8.8.1 Budgets Performance
- **Widget Ark UI** : < 150ms chargement
- **Bundle par widget** : < 80 KB
- **Interactions** : < 16ms (60fps)
- **MÃ©moire** : < 10MB par widget

### 8.8.2 Optimisations Ark UI
```typescript
// Lazy loading des composants
const LazyArkComponent = lazy(() => import('./ArkComponent'))

// Memoization des collections
const memoizedCollection = useMemo(() => 
  createListCollection({ items: data }), 
  [data]
)

// Virtualisation pour grandes listes
const VirtualizedList = ({ items }) => (
  <ArkComponent.Root>
    <FixedSizeList
      height={600}
      itemCount={items.length}
      itemSize={50}
    >
      {({ index, style }) => (
        <ArkComponent.Item style={style}>
          {items[index]}
        </ArkComponent.Item>
      )}
    </FixedSizeList>
  </ArkComponent.Root>
)
```

## 8.9 AccessibilitÃ© avec Ark UI

### 8.9.1 Standards WCAG 2.2
- **Contraste** : 4.5:1 minimum (AA)
- **Navigation clavier** : Tab, Enter, Espace, FlÃ¨ches
- **Lecteurs d'Ã©cran** : ARIA labels automatiques
- **Focus management** : Trap et restore

### 8.9.2 ImplÃ©mentation
```typescript
// AccessibilitÃ© automatique avec Ark UI
const AccessibleWidget = () => (
  <ArkComponent.Root>
    <ArkComponent.Label>
      Nom du champ
    </ArkComponent.Label>
    <ArkComponent.Input 
      aria-describedby="field-description"
      aria-required="true"
    />
    <ArkComponent.Description id="field-description">
      Description du champ
    </ArkComponent.Description>
    <ArkComponent.ErrorMessage>
      Message d'erreur
    </ArkComponent.ErrorMessage>
  </ArkComponent.Root>
)
---

## â˜‘ï¸ Checklist d'ImplÃ©mentation

- [ ] Ark UI comme bibliothÃ¨que principale
- [ ] Lucide React pour les icÃ´nes
- [ ] TypeScript pour la sÃ©curitÃ© de type
- [ ] Framer Motion pour les animations
- [ ] Collections Ark UI pour les donnÃ©es
- [ ] AccessibilitÃ© WCAG 2.2 AA
- [ ] Tests comportementaux et a11y
- [ ] Performance < 150ms
- [ ] Documentation des composants
- [ ] Migration progressive d'Ant Design

---

> **Version 8 â€“ Ark UI Integration**

## 9 Â· Mendix Integration Guidelines

### 9.1 Widget Architecture

* Respecter template widget Mendixâ€¯; fichiers `widget.xml` propres.
* Lifecycle (`update`, `uninitialize`) implÃ©mentÃ©s ; cleanup memory.
* Conversion entitÃ©s Mendix â†”â€¯DTO widget via adapters.

### 9.2 Performance & DOM

* Minimiser accÃ¨s direct DOM ; prÃ©fÃ©rer APIs Mendix.
* Validation & erreurs via microflows Mendix.
* Budget DOMÂ : <â€¯1000 nodes / widget.

### 9.3 Theming & Styling

* HÃ©riter des variables Atlas UI ; exposer `--mx-*` CSS vars.
* Support branding client via CSS props.

### 9.4 Packaging & Dependencies

* Bundle unique ES2017, <â€¯100â€¯KB ; externals AntD, React.
* Documentation `README.md` + exemples `mpk`.

---

### â˜‘ï¸ Rappel

* **Toujours** mettre Ã  jour `avancement.md` â€” date, changement, analyse, prochaines Ã©tapes.
* Si changement FSM â†’ diagramme Ã  jour.

---

> **Version 7 â€“ 19 juin 2025**
